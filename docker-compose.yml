version: '3.8'

services:
  # serwer ofiary (nginx) z mounted config (nginx.conf w ./nginx/nginx.conf)
  target_node:
    image: nginx:stable-alpine
    container_name: target_node
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/html:/usr/share/nginx/html:ro
    networks:
      - monitoring-net

  # exporter, który wystawia metryki Prometheusa z nginx (scrapuje /nginx_status)
  nginx_exporter:
    image: nginx/nginx-prometheus-exporter:0.11.0
    container_name: nginx_exporter
    ports:
      - "9113:9113"
    environment:
      - NGINX_STATUS_URL=http://target_node:80/nginx_status
    command:
      - -nginx.scrape-uri=http://target_node:80/nginx_status
    depends_on:
      - target_node
    networks:
      - monitoring-net

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      - nginx_exporter
    networks:
      - monitoring-net

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
    networks:
      - monitoring-net

  # kontener, z którego ręcznie będziesz wykonywać żądania (nie atakuje automatycznie)
  attacker_node:
    image: alpine:latest
    container_name: attacker_node
    networks:
      - monitoring-net
    command: [ "sh", "-c", "apk add --no-cache curl && tail -f /dev/null" ]
    depends_on:
      - target_node

networks:
  monitoring-net:
    driver: bridge
